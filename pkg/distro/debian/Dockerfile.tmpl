# syntax = docker/dockerfile-upstream:1.5.0@sha256:bda6ac9f61f2b676331acfd656a07bcd55b369143ab7db66bdf93b619da3e183
# ↑ For avoiding `failed to compute cache key: "/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" not found: not found` on Docker 20.10

# Generated by repro-get.

# Dockerfile for building a container image using the hash file.

# ⚠️  EXPERIMENTAL ⚠️

# Usage:
# Make sure that the hash file "SHA256SUMS-{{.OCIArchDashVariant}}" is present in the current directory.
# ----------------------------------------------------------
# export DOCKER_BUILDKIT=1
# docker build .
# ----------------------------------------------------------

ARG BASE_IMAGE={{.BaseImage}} # {{.BaseImageOrig}}
ARG REPRO_GET_PROVIDER={{join .Providers ","}}

ARG REPRO_GET_VERSION={{.ReproGetVersion}}
ARG REPRO_GET_SHA256SUMS_SHA256SUM={{.ReproGetSHASHA}}
{{snippet "fetch-repro-get"}}

FROM --platform=${TARGETPLATFORM} ${BASE_IMAGE} AS repro-get-main-0
ARG TARGETARCH
ARG TARGETVARIANT
ARG SOURCE_DATE_EPOCH
ARG REPRO_GET_PROVIDER
SHELL ["/bin/bash", "-c"]
# The cache dir is mounted under a directory inside tmpfs (/dev/*), so that the mount point directory does not remain in the image
RUN \
  --mount=type=cache,target=/dev/.cache/repro-get \
  --mount=type=bind,from=repro-get,source=/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}},target=/usr/local/bin/repro-get \
  --mount=type=bind,source=.,target=/mnt \
    set -eux -o pipefail ; \
    : "${SOURCE_DATE_EPOCH="$(stat --format=%Y /etc/apt/sources.list)"}" && \
    export SOURCE_DATE_EPOCH && \
    /usr/local/bin/repro-get --provider="${REPRO_GET_PROVIDER}" --cache=/dev/.cache/repro-get install "/mnt/SHA256SUMS-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" && \
    : Remove unneeded files for reproducibility && \
    find /var/log -name '*.log' -or -name '*.log.*' -newermt "@${SOURCE_DATE_EPOCH}" -not -type d | xargs rm -f && \
    find /run /tmp -newermt "@${SOURCE_DATE_EPOCH}" -not -type d -xdev | xargs rm -f && \
    rm -f /var/cache/ldconfig/* && \
    : Reset the timestamp for reproducibility && \
    find $( ls / | grep -E -v "^(dev|mnt|proc|sys)$" ) -newermt "@${SOURCE_DATE_EPOCH}" -writable -xdev | xargs touch --date="@${SOURCE_DATE_EPOCH}" --no-dereference
SHELL ["/sh", "-c"]

# Squash whiteouts (https://github.com/moby/buildkit/blob/984bcf9e8b643f2a9eca4c2680d262be361866c0/docs/build-repro.md#timestamps-of-whiteouts)
FROM scratch
COPY --from=repro-get-main-0 / /
