# syntax = docker/dockerfile-upstream:1.5.0@sha256:bda6ac9f61f2b676331acfd656a07bcd55b369143ab7db66bdf93b619da3e183
# ↑ For avoiding `failed to compute cache key: "/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" not found: not found` on Docker 20.10

# Generated by repro-get.

# "Timetraveling" Dockerfile for generating the hash file with a past snapshot.

# ⚠️  EXPERIMENTAL ⚠️

# Usage:
# ----------------------------------------------------------
# export DOCKER_BUILDKIT=1
# docker build --output . -f Dockerfile.generate-hash .
# ----------------------------------------------------------

# Output files:
# - SHA256SUMS-{{.OCIArchDashVariant}}: the hash file

ARG BASE_IMAGE={{.BaseImage}} # {{.BaseImageOrig}}
ARG PACKAGES="{{join .Packages " "}}"
ARG SNAPSHOT_ARCHIVE_BASE=http://snapshot.debian.org/archive/
# Backports do not seem cached in https://debian.notset.fr/
ARG BACKPORTS=0

ARG REPRO_GET_VERSION={{.ReproGetVersion}}
ARG REPRO_GET_SHA256SUMS_SHA256SUM={{.ReproGetSHASHA}}
{{snippet "fetch-repro-get"}}

FROM --platform=${TARGETPLATFORM} ${BASE_IMAGE} AS generate-hash
ARG PACKAGES
ARG SNAPSHOT_ARCHIVE_BASE
ARG TARGETARCH
ARG TARGETVARIANT
ARG SOURCE_DATE_EPOCH
ARG BACKPORTS
SHELL ["/bin/bash", "-c"]
RUN \
  --mount=type=cache,target=/var/cache/apt \
  --mount=type=cache,target=/var/lib/apt \
  --mount=type=cache,target=/var/cache/repro-get \
  --mount=type=bind,from=repro-get,source=/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}},target=/usr/local/bin/repro-get \
  set -eux -o pipefail; \
  . /etc/os-release && \
  export DEBIAN_FRONTEND=noninteractive && \
  : "${SOURCE_DATE_EPOCH="$(stat --format=%Y /etc/apt/sources.list)"}" && \
  export SOURCE_DATE_EPOCH && \
  snapshot="$(printf "%(%Y%m%dT%H%M%SZ)T\n" "${SOURCE_DATE_EPOCH}")" && \
  echo "deb [check-valid-until=no] ${SNAPSHOT_ARCHIVE_BASE}debian/${snapshot} ${VERSION_CODENAME} main" >/etc/apt/sources.list && \
  echo "deb [check-valid-until=no] ${SNAPSHOT_ARCHIVE_BASE}debian-security/${snapshot} ${VERSION_CODENAME}-security main" >>/etc/apt/sources.list && \
  echo "deb [check-valid-until=no] ${SNAPSHOT_ARCHIVE_BASE}debian/${snapshot} ${VERSION_CODENAME}-updates main" >>/etc/apt/sources.list && \
  if [ "${BACKPORTS}" = 1 ] ; then echo "deb [check-valid-until=no] ${SNAPSHOT_ARCHIVE_BASE}debian/${snapshot} ${VERSION_CODENAME}-backports main" >>/etc/apt/sources.list; fi&& \
  rm -f /etc/apt/apt.conf.d/docker-clean && \
  echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' >/etc/apt/apt.conf.d/keep-cache && \
  apt-get update && \
  mkdir -p /out && \
  /usr/local/bin/repro-get hash generate >"/out/SHA256SUMS-preinstalled" && \
  apt-get install -y --no-install-recommends ${PACKAGES} && \
  /usr/local/bin/repro-get hash generate --dedupe "/out/SHA256SUMS-preinstalled" >"/out/SHA256SUMS-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" && \
  rm -f "/out/SHA256SUMS-preinstalled" && \
  chmod 444 /out/* && \
  touch --date=@${SOURCE_DATE_EPOCH} /out/*

FROM scratch
COPY --from=generate-hash /out/ /
