# syntax = docker/dockerfile-upstream:1.5.0@sha256:bda6ac9f61f2b676331acfd656a07bcd55b369143ab7db66bdf93b619da3e183
# ↑ For avoiding `failed to compute cache key: "/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" not found: not found` on Docker 20.10

# Generated by repro-get.

# "Timetraveling" Dockerfile for generating the hash file with a past snapshot.

# ⚠️  EXPERIMENTAL ⚠️

# Usage:
# ----------------------------------------------------------
# export DOCKER_BUILDKIT=1
# docker build --output . -f Dockerfile.generate-hash .
# ----------------------------------------------------------

# Output files:
# - SHA256SUMS-{{.OCIArchDashVariant}}: the hash file

ARG BASE_IMAGE={{.BaseImage}} # {{.BaseImageOrig}}
ARG PACKAGES="{{join .Packages " "}}"

ARG REPRO_GET_VERSION={{.ReproGetVersion}}
ARG REPRO_GET_SHA256SUMS_SHA256SUM={{.ReproGetSHASHA}}
{{snippet "fetch-repro-get"}}

FROM --platform=${TARGETPLATFORM} ${BASE_IMAGE} AS generate-hash
ARG PACKAGES
ARG TARGETARCH
ARG TARGETVARIANT
ARG SOURCE_DATE_EPOCH
SHELL ["/bin/bash", "-c"]
RUN \
  --mount=type=cache,target=/var/cache/pacman \
  --mount=type=cache,target=/var/cache/repro-get \
  --mount=type=bind,from=repro-get,source=/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}},target=/usr/local/bin/repro-get \
  set -eux -o pipefail; \
  : "${SOURCE_DATE_EPOCH="$(stat --format=%Y /var/log/pacman.log)"}" && \
  export SOURCE_DATE_EPOCH && \
  date -d "@${SOURCE_DATE_EPOCH}" '+Server = https://archive.archlinux.org/repos/%Y/%m/%d/$repo/os/$arch' > /etc/pacman.d/mirrorlist && \
  pacman -Sy && \
  mkdir -p /out && \
  echo ${SOURCE_DATE_EPOCH} >/out/SOURCE_DATE_EPOCH && \
  /usr/local/bin/repro-get hash generate >"/out/SHA256SUMS-preinstalled" && \
  pacman -Su --noconfirm ${PACKAGES} && \
  /usr/local/bin/repro-get hash generate --dedupe "/out/SHA256SUMS-preinstalled" >"/out/SHA256SUMS-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" && \
  rm -f "/out/SHA256SUMS-preinstalled" && \
  chmod 444 /out/* && \
  touch --date=@${SOURCE_DATE_EPOCH} /out/*

FROM scratch
COPY --from=generate-hash /out/ /
