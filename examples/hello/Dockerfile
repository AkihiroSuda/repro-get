# syntax = docker/dockerfile-upstream:1.5.0@sha256:bda6ac9f61f2b676331acfd656a07bcd55b369143ab7db66bdf93b619da3e183
# ↑ For avoiding `failed to compute cache key: "/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" not found: not found` on Docker 20.10

# Generated by repro-get.

# Dockerfile for building a container image using the hash file.

# ⚠️  EXPERIMENTAL ⚠️

# Usage:
# Make sure that the hash file "SHA256SUMS-amd64" is present in the current directory.
# ----------------------------------------------------------
# export DOCKER_BUILDKIT=1
# docker build .
# ----------------------------------------------------------

ARG BASE_IMAGE=docker.io/library/debian:bullseye-20211220@sha256:2906804d2a64e8a13a434a1a127fe3f6a28bf7cf3696be4223b06276f32f1f2d # debian:bullseye-20211220
ARG REPRO_GET_PROVIDER=http://deb.debian.org/debian/{{.Name}},http://deb.debian.org/debian-security/{{.Name}},http://debian.notset.fr/snapshot/by-hash/SHA256/{{.SHA256}},http://archive.debian.org/debian/{{.Name}},http://archive.debian.org/debian-security/{{.Name}}

ARG REPRO_GET_VERSION=v0.2.1
ARG REPRO_GET_SHA256SUMS_SHA256SUM=a8cf7888129d23f2a6d81e61e0b316b27c4b0b8432a4c4a36e0303eddab70078
# "download" or "local"
ARG REPRO_GET_FETCH_MODE=download
ARG REPRO_GET_BINARY_URL=https://github.com/reproducible-containers/repro-get/releases/download/${REPRO_GET_VERSION}/repro-get-${REPRO_GET_VERSION}.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}
ARG REPRO_GET_SHA256SUMS_URL=https://github.com/reproducible-containers/repro-get/releases/download/${REPRO_GET_VERSION}/SHA256SUMS

FROM --platform=${TARGETPLATFORM} ${BASE_IMAGE} AS repro-get-download
ARG TARGETARCH
ARG TARGETVARIANT
ARG REPRO_GET_VERSION
ARG REPRO_GET_BINARY_URL
ARG REPRO_GET_SHA256SUMS_URL
ARG REPRO_GET_SHA256SUMS_SHA256SUM
ADD ${REPRO_GET_BINARY_URL} .
ADD ${REPRO_GET_SHA256SUMS_URL} .
RUN \
  echo "${REPRO_GET_SHA256SUMS_SHA256SUM}  SHA256SUMS" >SHASHA && \
  sha256sum -c SHASHA && \
  sha256sum --ignore-missing -c SHA256SUMS && \
  mv repro-get-${REPRO_GET_VERSION}.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}} repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}  && \
  chmod +x repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}

FROM scratch AS repro-get-local
ARG TARGETARCH
ARG TARGETVARIANT
COPY repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}} /

FROM repro-get-${REPRO_GET_FETCH_MODE} AS repro-get


FROM --platform=${TARGETPLATFORM} ${BASE_IMAGE} AS repro-get-main-0
ARG TARGETARCH
ARG TARGETVARIANT
ARG SOURCE_DATE_EPOCH
ARG REPRO_GET_PROVIDER
SHELL ["/bin/bash", "-c"]
# The cache dir is mounted under a directory inside tmpfs (/dev/*), so that the mount point directory does not remain in the image
RUN \
  --mount=type=cache,target=/dev/.cache/repro-get \
  --mount=type=bind,from=repro-get,source=/repro-get.linux-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}},target=/usr/local/bin/repro-get \
  --mount=type=bind,source=.,target=/mnt \
    set -eux -o pipefail ; \
    : "${SOURCE_DATE_EPOCH="$(stat --format=%Y /etc/apt/sources.list)"}" && \
    export SOURCE_DATE_EPOCH && \
    /usr/local/bin/repro-get --provider="${REPRO_GET_PROVIDER}" --cache=/dev/.cache/repro-get install "/mnt/SHA256SUMS-${TARGETARCH}${TARGETVARIANT:+-${TARGETVARIANT}}" && \
    : Remove unneeded files for reproducibility && \
    find /var/log -name '*.log' -or -name '*.log.*' -newermt "@${SOURCE_DATE_EPOCH}" -not -type d | xargs rm -f && \
    find /run /tmp -newermt "@${SOURCE_DATE_EPOCH}" -not -type d -xdev | xargs rm -f && \
    rm -f /var/cache/ldconfig/* && \
    : Reset the timestamp for reproducibility && \
    find $( ls / | grep -E -v "^(dev|mnt|proc|sys)$" ) -newermt "@${SOURCE_DATE_EPOCH}" -writable -xdev | xargs touch --date="@${SOURCE_DATE_EPOCH}" --no-dereference
SHELL ["/sh", "-c"]

# Squash whiteouts (https://github.com/moby/buildkit/blob/984bcf9e8b643f2a9eca4c2680d262be361866c0/docs/build-repro.md#timestamps-of-whiteouts)
FROM scratch
COPY --from=repro-get-main-0 / /
